name: Release Build

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬çš„æ ‡ç­¾ï¼ˆæ­£å¼ç‰ˆ/æµ‹è¯•ç‰ˆï¼‰
on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"                # åŒ¹é…æ­£å¼ç‰ˆæ ‡ç­¾ï¼Œå¦‚ 1.0.0ã€2.3.4
      - "[0-9]+.[0-9]+.[0-9]+-beta[0-9]+"     # åŒ¹é…æµ‹è¯•ç‰ˆæ ‡ç­¾ï¼Œå¦‚ 1.0.0-beta1ã€2.3.4-beta2

# æƒé™é…ç½®ï¼šèµ‹äºˆå‘å¸ƒæ‰€éœ€çš„å®Œæ•´å†™å…¥æƒé™
permissions:
  contents: write
  packages: write
  actions: write

# å¹¶å‘æ§åˆ¶ï¼šé¿å…é‡å¤è¿è¡Œï¼Œmaster åˆ†æ”¯ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
concurrency:
  group: "${{ github.workflow }} - ${{ github.head_ref || github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}

jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒç‰ˆæœ¬å·ï¼ˆtag ä¸ package.json ç‰ˆæœ¬ä¸€è‡´ï¼‰
  check-version:
    name: æ ¡éªŒç‰ˆæœ¬å·ä¸€è‡´æ€§
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… jq å·¥å…·ï¼ˆç”¨äºè§£æ package.jsonï¼‰
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: æ ¡éªŒ tag ä¸ package.json version åŒ¹é…
        id: version_check
        run: |
          # æå– tag åç§°ï¼ˆå»é™¤ refs/tags/ å‰ç¼€ï¼‰
          TAG_NAME="${GITHUB_REF##refs/tags/}"
          # æå– package.json ä¸­çš„ç‰ˆæœ¬å·
          PKG_VERSION=$(jq -r .version package.json)
          
          # å¯¹æ¯”ç‰ˆæœ¬å·
          if [[ "$PKG_VERSION" != "$TAG_NAME" ]]; then
            echo "âŒ ç‰ˆæœ¬å·ä¸åŒ¹é…ï¼špackage.json = $PKG_VERSIONï¼ŒTag = $TAG_NAME"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬å·åŒ¹é…ï¼š$TAG_NAME"
          # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=$TAG_NAME" >> $GITHUB_OUTPUT

  # ç¬¬äºŒæ­¥ï¼šå¤šå¹³å°æ‰“åŒ…æ„å»º
  build:
    name: æ„å»º ${{ matrix.name-suffix }} ç‰ˆæœ¬
    needs: check-version  # ä¾èµ–ç‰ˆæœ¬æ ¡éªŒé€šè¿‡
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # æŸä¸ªå¹³å°æ„å»ºå¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            script: build-w-64
            name-suffix: win_x64
          - os: windows-latest
            script: build-w
            name-suffix: win_ia32
          - os: macos-latest
            script: build-m-arm64
            name-suffix: mac_arm64
          - os: macos-latest
            script: build-m
            name-suffix: mac_x64
          - os: macos-latest
            script: build-m-universal
            name-suffix: mac_universal
          - os: ubuntu-latest
            script: build-l
            name-suffix: linux_x64
          - os: ubuntu-latest
            script: build-l-arm64
            name-suffix: linux_arm64
          - os: ubuntu-latest
            script: build-kylin
            name-suffix: Kylin_x64

    steps:
      - name: æ‹‰å–ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒï¼ˆ18.x ç‰ˆæœ¬ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"  # ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci  # ä½¿ç”¨ ci å‘½ä»¤æ›´ä¸¥æ ¼ï¼Œé€‚åˆ CI ç¯å¢ƒ

      - name: æ‰§è¡Œæ‰“åŒ…è„šæœ¬
        run: npm run ${{ matrix.script }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          VERSION: ${{ needs.check-version.outputs.VERSION }}  # ä¼ é€’ç‰ˆæœ¬å·

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name-suffix }}
          path: |
            out/*.exe
            out/*.dmg
            out/*.tar.xz
            out/*.deb
            out/*.AppImage  # è¡¥å……å¸¸è§ Linux æ‰“åŒ…æ ¼å¼
          retention-days: 7  # äº§ç‰©ä¿ç•™ 7 å¤©
          if-no-files-found: error  # æ— äº§ç‰©æ—¶æ ‡è®°ä¸ºé”™è¯¯

  # ç¬¬ä¸‰æ­¥ï¼šæ•´åˆäº§ç‰©å¹¶å‘å¸ƒ Release
  release:
    name: å‘å¸ƒ Release ç‰ˆæœ¬
    needs: build  # ä¾èµ–æ‰€æœ‰æ„å»ºä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå‘å¸ƒæ—¥æœŸï¼‰
        run: echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      # ä¸‹è½½æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
      - name: ä¸‹è½½ Windows äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: win_x64
          path: artifacts/win
      - name: ä¸‹è½½ Windows 32ä½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: win_ia32
          path: artifacts/win

      - name: ä¸‹è½½ macOS ARM64 äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: mac_arm64
          path: artifacts/mac
      - name: ä¸‹è½½ macOS x64 äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: mac_x64
          path: artifacts/mac
      - name: ä¸‹è½½ macOS é€šç”¨ç‰ˆäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: mac_universal
          path: artifacts/mac

      - name: ä¸‹è½½ Linux x64 äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: linux_x64
          path: artifacts/linux
      - name: ä¸‹è½½ Linux ARM64 äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: linux_arm64
          path: artifacts/linux

      - name: ä¸‹è½½éº’éºŸ x64 äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: Kylin_x64
          path: artifacts/Kylin

      # åˆ—å‡ºäº§ç‰©ç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯é€‰ï¼‰
      - name: æŸ¥çœ‹äº§ç‰©æ–‡ä»¶
        run: |
          echo "=== äº§ç‰©ç›®å½•ç»“æ„ ==="
          find artifacts -type f
          echo "===================="

      # å‘å¸ƒ GitHub Release
      - name: åˆ›å»º Release å¹¶ä¸Šä¼ äº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }} (${{ env.RELEASE_DATE }})
          draft: true  # è‰ç¨¿çŠ¶æ€ï¼Œéœ€æ‰‹åŠ¨å‘å¸ƒ
          generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
          # è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜
          body: |
            ## ğŸš€ ç‰ˆæœ¬å‘å¸ƒ ${{ github.ref_name }}
            å‘å¸ƒæ—¶é—´ï¼š${{ env.RELEASE_DATE }}
            ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ
            
            ### âš ï¸ é‡è¦æç¤ºï¼ˆmacOS ç”¨æˆ·ï¼‰
            è‹¥æç¤ºã€Œåº”ç”¨ç¨‹åºå·²æŸåã€ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è§£å†³ï¼š
            ```bash
            sudo xattr -r -d com.apple.quarantine /åº”ç”¨ç¨‹åºè·¯å¾„/hiprint.app